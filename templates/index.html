<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArXiv论文摘要生成器</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .loading {
            display: none;
        }
        .loading.active {
            display: block;
        }
        #results {
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">ArXiv论文摘要生成器</h1>
        
        <div class="card mb-4">
            <div class="card-body">
                <form id="searchForm">
                    <div class="mb-3">
                        <label for="keyword" class="form-label">关键词</label>
                        <input type="text" class="form-control" id="keyword" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="startDate" class="form-label">开始日期</label>
                            <input type="date" class="form-control" id="startDate" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="endDate" class="form-label">结束日期</label>
                            <input type="date" class="form-control" id="endDate" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">搜索论文</button>
                </form>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="alert alert-info">
                正在搜索和处理论文，请稍候...
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <h5 class="card-title">搜索结果</h5>
                <div id="results"></div>
            </div>
        </div>
    </div>

    <script>
        const API_KEY = 'sk-gLb8Dsr65fx6HIV5ayBIlfmRDp3vx43AkRw5xDOiLAxfQ6qc';

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function searchArxiv(keyword, startDate, endDate) {
            const arxivUrl = `https://export.arxiv.org/api/query?search_query=all:${encodeURIComponent(keyword)}&sortBy=submittedDate&sortOrder=descending&max_results=10`;
            
            const response = await fetch(arxivUrl);
            const text = await response.text();
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(text, "text/xml");
            
            const entries = xmlDoc.getElementsByTagName("entry");
            const results = [];

            for (let entry of entries) {
                const published = new Date(entry.getElementsByTagName("published")[0].textContent);
                const startDateTime = new Date(startDate);
                const endDateTime = new Date(endDate);

                if (published >= startDateTime && published <= endDateTime) {
                    results.push({
                        title: entry.getElementsByTagName("title")[0].textContent,
                        authors: Array.from(entry.getElementsByTagName("author")).map(author => 
                            author.getElementsByTagName("name")[0].textContent),
                        summary: entry.getElementsByTagName("summary")[0].textContent,
                        published: published.toISOString().split('T')[0],
                        link: entry.getElementsByTagName("id")[0].textContent,
                        pdfLink: entry.getElementsByTagName("link")[1]?.getAttribute("href") || ''
                    });
                }
            }

            return results;
        }

        async function getSummary(text, retryCount = 0) {
            try {
                const response = await fetch('https://api.moonshot.cn/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        model: "moonshot-v1-8k",
                        messages: [
                            {
                                role: "system",
                                content: "你是一个专业的学术论文分析助手。请用中文三句话简明扼要地总结论文的主要内容，包括：1.研究目的 2.采用方法 3.主要结论"
                            },
                            {
                                role: "user",
                                content: `请用三句话总结以下论文：\n\n${text}`
                            }
                        ],
                        temperature: 0.3
                    })
                });

                const data = await response.json();
                if (data.error) {
                    throw new Error(data.error.message);
                }
                return data.choices[0].message.content;
            } catch (error) {
                // 如果是API限制错误，等待较长时间
                if (error.message.includes('Rate limit') || error.message.includes('max request')) {
                    await sleep(3000);
                } else {
                    await sleep(1000);
                }
                // 持续重试直到成功
                return getSummary(text, retryCount + 1);
            }
        }

        async function processPaperBatch(papers, startIndex, results) {
            const batchSize = 3;
            const endIndex = Math.min(startIndex + batchSize, papers.length);
            const batch = papers.slice(startIndex, endIndex);
            
            // 并行处理这一批论文
            const summaryPromises = batch.map(async (paper) => {
                let summary = null;
                while (!summary) {
                    try {
                        summary = await getSummary(paper.summary);
                    } catch (error) {
                        await sleep(1000);
                    }
                }
                return { paper, summary };
            });

            // 等待所有摘要生成完成
            const results_array = await Promise.all(summaryPromises);
            
            // 更新输出
            let output = results.textContent;
            for (const { paper, summary } of results_array) {
                const paperStart = output.indexOf(`标题：${paper.title}`);
                const nextPaper = output.indexOf('==================================================', paperStart);
                
                if (paperStart !== -1) {
                    const beforePaper = output.substring(0, paperStart);
                    const afterPaper = nextPaper !== -1 ? output.substring(nextPaper) : '';
                    
                    let paperContent = `发布时间：${paper.published}\n`;
                    paperContent += `标题：${paper.title}\n`;
                    paperContent += `作者：${paper.authors.join(', ')}\n`;
                    paperContent += `主要内容：\n${summary}\n\n`;
                    paperContent += `arXiv链接：${paper.link}\n`;
                    paperContent += `PDF链接：${paper.pdfLink}\n`;
                    paperContent += `${'='.repeat(50)}\n\n`;
                    
                    output = beforePaper + paperContent + afterPaper;
                }
            }
            results.textContent = output;
            
            // 如果还有更多论文要处理
            if (endIndex < papers.length) {
                await sleep(8000); // 等待8秒后处理下一批
                await processPaperBatch(papers, endIndex, results);
            }
        }

        document.getElementById('searchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const keyword = document.getElementById('keyword').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            
            loading.classList.add('active');
            results.innerHTML = '';

            try {
                const papers = await searchArxiv(keyword, startDate, endDate);
                
                if (papers.length === 0) {
                    results.innerHTML = `
                        <div class="alert alert-warning">
                            未找到符合条件的论文。<br>
                            建议：<br>
                            1. 扩大搜索时间范围<br>
                            2. 尝试使用更通用的关键词<br>
                            3. 检查关键词拼写是否正确
                        </div>
                    `;
                } else {
                    let output = `搜索关键词: ${keyword}\n时间范围: ${startDate} 至 ${endDate}\n\n`;
                    
                    // 显示所有论文的基本信息
                    for (const paper of papers) {
                        output += `发布时间：${paper.published}\n`;
                        output += `标题：${paper.title}\n`;
                        output += `作者：${paper.authors.join(', ')}\n`;
                        output += `正在等待处理...\n`;
                        output += `arXiv链接：${paper.link}\n`;
                        output += `PDF链接：${paper.pdfLink}\n`;
                        output += `${'='.repeat(50)}\n\n`;
                    }
                    
                    results.textContent = output;

                    // 开始批量处理
                    await processPaperBatch(papers, 0, results);
                }
            } catch (error) {
                results.textContent = "搜索论文时出错，请重试...\n";
            } finally {
                loading.classList.remove('active');
            }
        });
    </script>
</body>
</html>
