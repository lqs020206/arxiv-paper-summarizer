<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArXiv论文摘要生成器</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .loading {
            display: none;
        }
        .loading.active {
            display: block;
        }
        #results {
            white-space: pre-wrap;
        }
        .progress-container {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">ArXiv论文摘要生成器</h1>
        
        <div class="card mb-4">
            <div class="card-body">
                <form id="searchForm">
                    <div class="mb-3">
                        <label for="keyword" class="form-label">关键词</label>
                        <input type="text" class="form-control" id="keyword" placeholder="输入关键词" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="startDate" class="form-label">开始日期</label>
                            <input type="date" class="form-control" id="startDate" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="endDate" class="form-label">结束日期</label>
                            <input type="date" class="form-control" id="endDate" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">搜索论文</button>
                </form>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="alert alert-info">
                正在搜索和处理论文，请稍候...
            </div>
        </div>

        <div class="progress-container">
            <div class="progress">
                <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
            </div>
            <p id="progressText" class="mt-2">0 / 0 完成</p>
        </div>

        <div class="card mt-4">
            <div class="card-body">
                <h5 class="card-title">搜索结果</h5>
                <div id="results"></div>
            </div>
        </div>
    </div>

    <script>

        const API_KEY = 'sk-gLb8Dsr65fx6HIV5ayBIlfmRDp3vx43AkRw5xDOiLAxfQ6qc';

        // 延迟函数
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // 设置结束日期为当前日期
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('endDate').valueAsDate = new Date();
        });

        // ArXiv搜索函数
        async function searchArxiv(keyword, startDate, endDate) {
            // const arxivUrl = `https://export.arxiv.org/api/query?search_query=all:${encodeURIComponent(keyword)}&sortBy=submittedDate&sortOrder=descending&max_results=30`;
            const arxivUrl = `https://export.arxiv.org/api/query?search_query=ti:${encodeURIComponent(keyword)} OR abs:${encodeURIComponent(keyword)}&sortBy=submittedDate&sortOrder=descending&max_results=30`;

            const response = await fetch(arxivUrl);
            if (!response.ok) {
                throw new Error(`ArXiv API请求失败: ${response.statusText}`);
            }
            const text = await response.text();
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(text, "application/xml");
            
            const entries = xmlDoc.getElementsByTagName("entry");
            const results = [];

            for (let entry of entries) {
                const published = new Date(entry.getElementsByTagName("published")[0].textContent);
                const startDateTime = new Date(startDate);
                const endDateTime = new Date(endDate);

                if (published >= startDateTime && published <= endDateTime) {
                    results.push({
                        title: entry.getElementsByTagName("title")[0].textContent.trim(),
                        authors: Array.from(entry.getElementsByTagName("author")).map(author => 
                            author.getElementsByTagName("name")[0].textContent.trim()),
                        summary: entry.getElementsByTagName("summary")[0].textContent.trim(),
                        published: published.toISOString().split('T')[0],
                        link: entry.getElementsByTagName("id")[0].textContent.trim(),
                        pdfLink: Array.from(entry.getElementsByTagName("link")).find(link => link.getAttribute("title") === "pdf")?.getAttribute("href") || ''
                    });
                }
            }

            return results;
        }

        // Moonshot API调用函数
        async function getSummary(text) {
            const response = await fetch('https://api.moonshot.cn/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${API_KEY}`
                },
                body: JSON.stringify({
                    model: "moonshot-v1-8k",
                    messages: [
                        {
                            role: "system",
                            content: "你是一个专业的学术论文分析助手。请用中文三句话简明扼要地总结论文的主要内容，包括：1.研究目的 2.采用方法 3.主要结论"
                        },
                        {
                            role: "user",
                            content: `请用三句话总结以下论文：\n\n${text}`
                        }
                    ],
                    temperature: 0.3
                })
            });

            const data = await response.json();
            if (!response.ok) {
                const errorMsg = data.error?.message || '未知错误';
                throw new Error(`Moonshot API请求失败: ${errorMsg}`);
            }
            return data.choices[0].message.content.trim();
        }

        // 处理任务，确保顺序发送请求，并加入重试机制
        async function processSequentially(papers, onProgress, displayResultFunc) {
            const total = papers.length;
            let completed = 0;

            for (let i = 0; i < papers.length; i++) {
                const paper = papers[i];
                let attempt = 0;
                const maxRetries = 5;
                let waitTime = 3000; // 初始等待时间3秒

                while (attempt < maxRetries) {
                    try {
                        const summary = await getSummary(paper.summary);
                        displayResultFunc(paper, summary);
                        break; // 成功后跳出重试循环
                    } catch (error) {
                        attempt++;
                        console.error(`处理论文 "${paper.title}" 时出错（第${attempt}次尝试）:`, error);

                        if (attempt < maxRetries) {
                            console.warn(`等待${waitTime / 1000}秒后重试...`);
                            await sleep(waitTime); // 等待后重试
                            waitTime *= 2; // 指数退避
                        } else {
                            console.error(`达到最大重试次数。论文 "${paper.title}" 的摘要生成失败。`);
                            displayResultFunc(paper, null, '摘要生成失败: 达到最大重试次数');
                        }
                    }
                }

                completed++;
                if (onProgress) {
                    onProgress(completed, total);
                }

                // 等待3秒后处理下一个请求
                await sleep(3000);
            }
        }

        // 更新进度条和进度文本
        function updateProgress(current, total) {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const percentage = total === 0 ? 0 : Math.floor((current / total) * 100);
            progressBar.style.width = `${percentage}%`;
            progressBar.setAttribute('aria-valuenow', percentage);
            progressBar.textContent = `${percentage}%`;
            progressText.textContent = `${current} / ${total} 完成`;
        }

        // 更新结果到页面
        function displayResult(paper, summary, error = null) {
            const results = document.getElementById('results');
            const paperElement = document.createElement('div');
            paperElement.classList.add('mb-4');
            paperElement.innerHTML = `
                <p><strong>发布时间：</strong>${paper.published}</p>
                <p><strong>标题：</strong>${paper.title}</p>
                <p><strong>作者：</strong>${paper.authors.join(', ')}</p>
                <p><strong>主要内容：</strong>${error ? `<span class="text-danger">摘要生成失败: ${error}</span>` : summary}</p>
                <p><a href="${paper.link}" target="_blank">arXiv链接</a></p>
                <p><a href="${paper.pdfLink}" target="_blank">PDF链接</a></p>
                <hr>
            `;
            results.appendChild(paperElement);
        }

        document.getElementById('searchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const keyword = document.getElementById('keyword').value.trim();
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');

            loading.classList.add('active');
            results.innerHTML = '';
            updateProgress(0, 0);

            try {
                // 搜索ArXiv论文
                const papers = await searchArxiv(keyword, startDate, endDate);
                
                if (papers.length === 0) {
                    results.innerHTML = `
                        <div class="alert alert-warning">
                            未找到符合条件的论文。<br>
                            建议：<br>
                            1. 扩大搜索时间范围<br>
                            2. 尝试使用更通用的关键词<br>
                            3. 检查关键词拼写是否正确
                        </div>
                    `;
                    updateProgress(0, 0);
                } else {
                    // 显示搜索基本信息
                    const info = document.createElement('div');
                    info.innerHTML = `<p><strong>搜索关键词:</strong> ${keyword}</p>
                                      <p><strong>时间范围:</strong> ${startDate} 至 ${endDate}</p><hr>`;
                    results.appendChild(info);

                    // 更新进度条总量
                    updateProgress(0, papers.length);

                    // 处理论文摘要，确保顺序发送请求，并加入重试机制
                    await processSequentially(papers, (completed, total) => {
                        updateProgress(completed, total);
                    }, displayResult);
                    
                    // 确保进度条显示100%完成
                    updateProgress(papers.length, papers.length);
                }
            } catch (error) {
                console.error("处理过程中出错:", error);
                results.innerHTML = `
                    <div class="alert alert-danger">
                        处理过程中出错，请重试...<br>
                        错误信息: ${error.message}
                    </div>
                `;
                updateProgress(0, 0);
            } finally {
                loading.classList.remove('active');
            }
        });
    </script>
</body>
</html>
