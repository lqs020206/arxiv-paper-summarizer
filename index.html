<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArXivè®ºæ–‡æ‘˜è¦ç”Ÿæˆå™¨ (Fix v3.1)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .loading { display: none; }
        .loading.active { display: block; }
        #results { white-space: pre-wrap; }
        .progress-container { margin-top: 20px; }
        .card-title { display: flex; justify-content: space-between; align-items: center; }
        #selectForm, #paperSelectionCard, #controlButtons, #resultsCard { display: none; }
        
        /* è°ƒè¯•é¢æ¿æ ·å¼ */
        #debugPanel {
            margin-top: 10px;
            padding: 15px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            color: #333;
            display: none; /* ã€ä¿®æ”¹ç‚¹ã€‘é»˜è®¤éšè— */
        }
        .log-entry { margin-bottom: 4px; border-bottom: 1px dashed #eee; }
        .log-pass { color: green; font-weight: bold; }
        .log-fail { color: #dc3545; }
        .log-info { color: #0d6efd; }
        .log-warn { color: #fd7e14; }
        .log-wait { color: #6c757d; font-style: italic; }
    </style>
</head>
<body>
    <div class="container mt-5 mb-5">
        <h1 class="mb-4">ArXivè®ºæ–‡æ‘˜è¦ç”Ÿæˆå™¨ <span class="badge bg-secondary fs-6">v3.1</span></h1>
        
        <div class="card mb-4">
            <div class="card-body">
                <form id="searchForm">
                    <div class="mb-3">
                        <label for="keyword" class="form-label">å…³é”®è¯</label>
                        <input type="text" class="form-control" id="keyword" placeholder="ä¾‹å¦‚: wireless communication" required>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="startDate" class="form-label">å¼€å§‹æ—¥æœŸ</label>
                            <input type="date" class="form-control" id="startDate" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="endDate" class="form-label">ç»“æŸæ—¥æœŸ</label>
                            <input type="date" class="form-control" id="endDate" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="searchDepth" class="form-label">æœç´¢æ·±åº¦</label>
                            <select class="form-select" id="searchDepth">
                                <option value="100">å‰ 100 ç¯‡ (å¿«é€Ÿ)</option>
                                <option value="300" selected>å‰ 300 ç¯‡ (æ¨è)</option>
                                <option value="500">å‰ 500 ç¯‡ (æ·±æœ)</option>
                                <option value="1000">å‰ 1000 ç¯‡ (ææ…¢)</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">å¼€å§‹æœç´¢</button>
                </form>
            </div>
        </div>

        <div class="card mb-4" id="paperSelectionCard">
            <div class="card-body">
                <h5 class="card-title">é€‰æ‹©è¦å¤„ç†çš„è®ºæ–‡ <span id="paperCountBadge" class="badge bg-primary rounded-pill">0</span></h5>
                <div class="mb-3">
                    <button class="btn btn-sm btn-secondary me-2" id="selectAllBtn">å…¨é€‰</button>
                    <button class="btn btn-sm btn-secondary me-2" id="deselectAllBtn">å–æ¶ˆå…¨é€‰</button>
                    <button class="btn btn-primary" id="processSelectedBtn">å¤„ç†é€‰ä¸­è®ºæ–‡</button>
                </div>
                <div id="paperCheckboxList" class="list-group" style="max-height: 500px; overflow-y: auto;">
                </div>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="alert alert-info">
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                <span id="loadingText">æ­£åœ¨è¿æ¥æ•°æ®åº“...</span>
            </div>
        </div>

        <div class="progress-container">
            <div class="progress">
                <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%;">0%</div>
            </div>
            <p id="progressText" class="mt-2">0 / 0 å®Œæˆ</p>
        </div>

        <div class="control-buttons mb-4" id="controlButtons">
            <button id="stopButton" class="btn btn-danger">åœæ­¢</button>
            <button id="startButton" class="btn btn-primary" style="display: none;">ç»§ç»­</button>
        </div>

        <div class="card mt-4 mb-4" id="resultsCard">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">æ‘˜è¦ç»“æœ</h5>
                    <button id="copyButton" class="btn btn-sm btn-secondary">ä¸€é”®å¤åˆ¶</button>
                </div>
                <div id="results" class="mt-3"></div>
            </div>
        </div>

        <div class="d-flex justify-content-end">
            <button id="toggleDebugBtn" class="btn btn-outline-secondary btn-sm" type="button">
                æ˜¾ç¤ºè°ƒè¯•æ—¥å¿—
            </button>
        </div>

        <div id="debugPanel">
            <strong>è°ƒè¯•æ—¥å¿— (Debug Log):</strong><br>
            <div id="debugContent">ç­‰å¾…æ“ä½œ...</div>
        </div>
    </div>

    <div id="copyAlert" class="alert alert-success alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; display: none; z-index: 9999;">
        å·²æˆåŠŸå¤åˆ¶ï¼<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="å…³é—­"></button>
    </div>
    <div id="copyErrorAlert" class="alert alert-danger alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; display: none; z-index: 9999;">
        æ“ä½œå¤±è´¥ï¼<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="å…³é—­"></button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ============================================================
        const WORKER_URL = 'https://arxiv.ghgftyu3.workers.dev'; 
        // ============================================================

        function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }
        
        function debugLog(msg, type = 'normal') {
            const content = document.getElementById('debugContent');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            if (type === 'pass') entry.classList.add('log-pass');
            if (type === 'fail') entry.classList.add('log-fail');
            if (type === 'info') entry.classList.add('log-info');
            if (type === 'warn') entry.classList.add('log-warn');
            if (type === 'wait') entry.classList.add('log-wait');
            const time = new Date().toLocaleTimeString();
            entry.textContent = `[${time}] ${msg}`;
            content.insertBefore(entry, content.firstChild);
        }

        // ã€æ–°å¢ã€‘æ§åˆ¶æ—¥å¿—æ˜¾ç¤º/éšè—
        document.getElementById('toggleDebugBtn').addEventListener('click', function() {
            const panel = document.getElementById('debugPanel');
            if (panel.style.display === 'none' || panel.style.display === '') {
                panel.style.display = 'block';
                this.textContent = 'éšè—è°ƒè¯•æ—¥å¿—';
            } else {
                panel.style.display = 'none';
                this.textContent = 'æ˜¾ç¤ºè°ƒè¯•æ—¥å¿—';
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            document.getElementById('endDate').valueAsDate = today;
            const lastYear = new Date();
            lastYear.setFullYear(today.getFullYear() - 1);
            document.getElementById('startDate').valueAsDate = lastYear;
        });

        let allPapers = [];
        let selectedPapers = [];
        let isStopped = false;
        let isProcessing = false;
        let currentIndex = 0;

        // === æ ¸å¿ƒæœç´¢å‡½æ•°ï¼šé«˜ç¨³å®šç‰ˆ ===
        async function searchArxiv(keyword, startDate, endDate) {
            const depth = parseInt(document.getElementById('searchDepth').value);
            debugLog(`å¼€å§‹æœç´¢... æ·±åº¦: Top ${depth} | å…³é”®è¯: "${keyword}"`, 'info');
            
            const startYear = new Date(startDate).getFullYear();
            const endYear = new Date(endDate).getFullYear();
            const queryWithYear = `${keyword} year:${startYear}-${endYear}`;
            
            let combinedData = [];
            const loadingText = document.getElementById('loadingText');

            // å¾ªç¯æŠ“å–
            for (let offset = 0; offset < depth; offset += 100) {
                if (loadingText) loadingText.textContent = `æ­£åœ¨æŠ“å–ç¬¬ ${(offset/100)+1} é¡µ (Offset ${offset})...`;
                debugLog(`å‘èµ·è¯·æ±‚: Offset ${offset}`, 'info');

                let retryCount = 0;
                const maxRetries = 2; // å¢åŠ é‡è¯•æ¬¡æ•°
                let success = false;

                while (retryCount <= maxRetries && !success) {
                    try {
                        const url = `${WORKER_URL}/arxiv?search_query=${encodeURIComponent(queryWithYear)}&offset=${offset}`;
                        const response = await fetch(url);
                        
                        if (response.ok) {
                            const json = await response.json();
                            if (json.data && json.data.length > 0) {
                                combinedData = combinedData.concat(json.data);
                                debugLog(`âœ… Offset ${offset}: æˆåŠŸè·å– ${json.data.length} æ¡`, 'pass');
                                success = true;
                            } else {
                                debugLog(`âš ï¸ Offset ${offset}: è¿”å›ç©ºæ•°æ®ï¼Œåœæ­¢ç¿»é¡µ`, 'warn');
                                offset = depth; // ç»“æŸ
                                success = true;
                            }
                        } else if (response.status === 429) {
                            debugLog(`ğŸ›‘ Offset ${offset}: è§¦å‘é™æµ (429)ï¼Œå†·å´ 10ç§’åé‡è¯•...`, 'warn');
                            await sleep(10000); 
                            retryCount++;
                        } else {
                            throw new Error(`HTTP ${response.status}`);
                        }
                    } catch (err) {
                        debugLog(`âŒ Offset ${offset}: ç½‘ç»œé”™è¯¯ ${err.message}ï¼Œç­‰å¾… 3ç§’åé‡è¯•`, 'fail');
                        retryCount++;
                        await sleep(3000);
                    }
                }

                if (!success) {
                    debugLog(`âŒ Offset ${offset}: é‡è¯•å¤šæ¬¡å¤±è´¥ï¼Œè·³è¿‡æ­¤é¡µ`, 'fail');
                }

                // å¸¸è§„é—´éš” 4 ç§’
                if (offset < depth - 100) {
                    debugLog(`...å®‰å…¨ç­‰å¾… 4 ç§’...`, 'wait');
                    await sleep(4000); 
                }
            }

            debugLog(`åŸå§‹æ•°æ®æŠ“å–å®Œæˆï¼Œå…±è·å¾— ${combinedData.length} ç¯‡å€™é€‰è®ºæ–‡`, 'info');
            
            if (combinedData.length === 0) return [];

            // å»é‡
            const uniqueMap = new Map();
            combinedData.forEach(p => {
                if(p.paperId) uniqueMap.set(p.paperId, p);
            });
            const uniquePapers = Array.from(uniqueMap.values());
            debugLog(`å»é‡åå‰©ä½™ ${uniquePapers.length} ç¯‡ï¼Œå¼€å§‹æ—¥æœŸç²¾ç¡®ç­›é€‰...`, 'info');

            const results = [];
            const startObj = new Date(startDate);
            const endObj = new Date(endDate);
            endObj.setHours(23, 59, 59, 999); 

            let passCount = 0;

            for (let paper of uniquePapers) {
                if (!paper.abstract) continue; 

                let isMatch = false;
                let paperDateStr = "æœªçŸ¥";

                if (paper.publicationDate) {
                    paperDateStr = paper.publicationDate;
                    const paperDate = new Date(paper.publicationDate);
                    if (paperDate >= startObj && paperDate <= endObj) isMatch = true;
                } else if (paper.year) {
                    paperDateStr = `${paper.year} (ä»…å¹´ä»½)`;
                    const pYear = parseInt(paper.year);
                    if (pYear >= startYear && pYear <= endYear) isMatch = true;
                }

                if (isMatch) {
                    debugLog(`[ä¿ç•™] ${paperDateStr} | ${paper.title.substring(0, 30)}...`, 'pass');
                    const pdfLink = paper.openAccessPdf ? paper.openAccessPdf.url : (paper.url || '');
                    const authors = paper.authors ? paper.authors.map(a => a.name) : ['Unknown'];

                    results.push({
                        title: paper.title,
                        authors: authors,
                        summary: paper.abstract,
                        published: paper.publicationDate || paper.year.toString(),
                        link: paper.url,
                        pdfLink: pdfLink
                    });
                    passCount++;
                }
            }

            debugLog(`ç­›é€‰å®Œæˆ: æœ€ç»ˆä¿ç•™ ${passCount} ç¯‡`, 'info');
            return results;
        }

        async function getSummary(text) {
            const response = await fetch(`${WORKER_URL}/moonshot`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: "moonshot-v1-8k",
                    messages: [
                        { role: "system", content: "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å­¦æœ¯è®ºæ–‡åˆ†æåŠ©æ‰‹ã€‚è¯·ç”¨ä¸­æ–‡ä¸‰å¥è¯ç®€æ˜æ‰¼è¦åœ°æ€»ç»“è®ºæ–‡çš„ä¸»è¦å†…å®¹ï¼ŒåŒ…æ‹¬ï¼š1.ç ”ç©¶ç›®çš„ 2.é‡‡ç”¨æ–¹æ³• 3.ä¸»è¦ç»“è®º" },
                        { role: "user", content: `è¯·ç”¨ä¸‰å¥è¯æ€»ç»“ä»¥ä¸‹è®ºæ–‡ï¼š\n\n${text}` }
                    ],
                    temperature: 0.3
                })
            });

            const data = await response.json();
            if (!response.ok) throw new Error(data.error?.message || 'APIè¯·æ±‚å¤±è´¥');
            return data.choices[0].message.content.trim();
        }

        // UI Logic
        document.getElementById('searchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            resetUI();
            document.getElementById('debugContent').innerHTML = ''; 
            
            const keyword = document.getElementById('keyword').value.trim();
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            document.getElementById('loading').classList.add('active');
            
            try {
                const papers = await searchArxiv(keyword, startDate, endDate);
                allPapers = papers;
                
                if (papers.length === 0) {
                    showAlert('copyErrorAlert', 'æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è®ºæ–‡ã€‚');
                } else {
                    displayPaperSelectionList(papers);
                }
            } catch (error) {
                console.error(error);
                debugLog("å‘ç”Ÿé”™è¯¯: " + error.message, 'fail');
                showAlert('copyErrorAlert', `æœç´¢å‡ºé”™: ${error.message}`);
            } finally {
                document.getElementById('loading').classList.remove('active');
            }
        });

        document.getElementById('processSelectedBtn').addEventListener('click', async () => {
            const checkboxes = document.querySelectorAll('.paper-checkbox:checked');
            if (checkboxes.length === 0) return showAlert('copyErrorAlert', 'è¯·è‡³å°‘é€‰æ‹©ä¸€ç¯‡è®ºæ–‡');
            selectedPapers = Array.from(checkboxes).map(cb => allPapers[parseInt(cb.value)]);
            startProcessing();
        });

        function displayPaperSelectionList(papers) {
            const list = document.getElementById('paperCheckboxList');
            document.getElementById('paperCountBadge').textContent = papers.length;
            list.innerHTML = '';
            papers.forEach((paper, index) => {
                const item = document.createElement('div');
                item.className = 'list-group-item';
                item.innerHTML = `
                    <div class="form-check">
                        <input class="form-check-input paper-checkbox" type="checkbox" value="${index}" id="paper${index}">
                        <label class="form-check-label" for="paper${index}">
                            <strong>${paper.title}</strong><br>
                            <small class="text-muted">æ—¥æœŸ: ${paper.published} | ä½œè€…: ${paper.authors.join(', ')}</small>
                        </label>
                    </div>`;
                list.appendChild(item);
            });
            document.getElementById('paperSelectionCard').style.display = 'block';
        }

        async function startProcessing() {
            document.getElementById('paperSelectionCard').style.display = 'none';
            document.getElementById('resultsCard').style.display = 'block';
            document.getElementById('controlButtons').style.display = 'block';
            document.getElementById('stopButton').style.display = 'inline-block';
            document.getElementById('startButton').style.display = 'none';
            document.getElementById('results').innerHTML = '';
            isProcessing = true;
            isStopped = false;
            currentIndex = 0;
            updateProgress(0, selectedPapers.length);
            await processQueue();
        }

        async function processQueue() {
            const total = selectedPapers.length;
            for (; currentIndex < total; currentIndex++) {
                if (isStopped) { isProcessing = false; return; }
                const paper = selectedPapers[currentIndex];
                debugLog(`æ­£åœ¨ç”Ÿæˆæ‘˜è¦: ${paper.title}`, 'info');
                try {
                    const summary = await getSummary(paper.summary);
                    displayResult(paper, summary);
                    debugLog(`æ‘˜è¦ç”ŸæˆæˆåŠŸ`, 'pass');
                } catch (error) {
                    displayResult(paper, null, error.message);
                    debugLog(`æ‘˜è¦å¤±è´¥: ${error.message}`, 'fail');
                }
                updateProgress(currentIndex + 1, total);
                if (currentIndex < total - 1) await sleep(2000); 
            }
            isProcessing = false;
            document.getElementById('stopButton').style.display = 'none';
            debugLog("æ‰€æœ‰ä»»åŠ¡å¤„ç†å®Œæˆã€‚", 'pass');
        }

        function displayResult(paper, summary, error = null) {
            const div = document.createElement('div');
            div.className = 'mb-4 border-bottom pb-3';
            let linksHtml = `<a href="${paper.link}" target="_blank">Semantic Scholarè¯¦æƒ…</a>`;
            if (paper.pdfLink) linksHtml = `<a href="${paper.pdfLink}" target="_blank"><strong>[PDFä¸‹è½½]</strong></a> | ` + linksHtml;
            div.innerHTML = `
                <p><strong>æ ‡é¢˜ï¼š</strong>${paper.title}</p>
                <p><strong>æ—¥æœŸï¼š</strong>${paper.published}</p>
                <p><strong>å†…å®¹ï¼š</strong>${error ? `<span class="text-danger">é”™è¯¯: ${error}</span>` : summary}</p>
                <p>${linksHtml}</p>
            `;
            document.getElementById('results').appendChild(div);
        }

        document.getElementById('selectAllBtn').onclick = () => document.querySelectorAll('.paper-checkbox').forEach(c => c.checked = true);
        document.getElementById('deselectAllBtn').onclick = () => document.querySelectorAll('.paper-checkbox').forEach(c => c.checked = false);
        
        document.getElementById('stopButton').onclick = () => {
            if (isProcessing) { isStopped = true; document.getElementById('stopButton').style.display = 'none'; document.getElementById('startButton').style.display = 'inline-block'; debugLog("ä»»åŠ¡å·²æš‚åœ", 'fail'); }
        };
        document.getElementById('startButton').onclick = () => {
            if (!isProcessing) { isStopped = false; isProcessing = true; document.getElementById('stopButton').style.display = 'inline-block'; document.getElementById('startButton').style.display = 'none'; debugLog("ä»»åŠ¡ç»§ç»­", 'info'); processQueue(); }
        };
        document.getElementById('copyButton').onclick = async () => {
            const text = document.getElementById('results').innerText;
            if(!text) return;
            try { await navigator.clipboard.writeText(text); showAlert('copyAlert'); } 
            catch { showAlert('copyErrorAlert', 'å¤åˆ¶å¤±è´¥'); }
        };

        function updateProgress(current, total) {
            const pct = Math.floor((current / total) * 100);
            document.getElementById('progressBar').style.width = `${pct}%`;
            document.getElementById('progressBar').textContent = `${pct}%`;
            document.getElementById('progressText').textContent = `${current} / ${total} å®Œæˆ`;
        }

        function resetUI() {
            document.getElementById('paperSelectionCard').style.display = 'none';
            document.getElementById('resultsCard').style.display = 'none';
            document.getElementById('controlButtons').style.display = 'none';
            document.getElementById('results').innerHTML = '';
        }

        function showAlert(id, msg) {
            const el = document.getElementById(id);
            if (!el) { console.warn(`Missing alert: ${id}`); alert(msg); return; }
            if (msg) {
                if (el.childNodes.length > 0 && el.childNodes[0].nodeType === 3) el.childNodes[0].nodeValue = msg + " ";
                else el.prepend(msg + " ");
            }
            el.style.display = 'block';
            setTimeout(() => { if(el) el.style.display = 'none'; }, 3000);
        }
    </script>
</body>
</html>